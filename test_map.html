<!DOCTYPE html>
<meta charset="utf-8">

<script src="https://d3js.org/d3.v4.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>


<style>
  body {
  background-color: #F2F3F6;
  min-height: 100%;
  font-family: "Verdana", sans-serif;
}

h1 {
  margin: 0;
  font-size: 20px;
  text-align: center;
}

#legend {
  font-size: 0.7em;
  letter-spacing: 0.1;
}

.map {
  padding: 20px;
  background-color: #FFFFFF;
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
}

div.tooltip {   
  position: absolute;
  padding: 7px;
  font-size: 0.8em;
  pointer-events: none;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;
  box-shadow: 3px 3px 10px 0px rgba(0, 0, 0, 0.25);
}  

.background {
  fill: transparent;
  pointer-evens: all;
}

.world {
  transform-origin: center;
}
</style>

<div class="map">
  <h1>World population map</h1>
  <svg id="my_dataviz" width="800" height="450"></svg></div>


<script>
  // initial setup
const svg = d3.select("svg"),
	width = svg.attr("width"),
	height = svg.attr("height"),
	path = d3.geoPath(),
	data = d3.map(),
	worldmap = "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson",
	worldpopulation = "./data/map/athletes_by_country.csv";

let centered, world;

// style of geographic projection and scaling
const projection = d3.geoRobinson()
	.scale(130)
	.translate([width / 2, height / 2]);

// Define color scale
const colorScale = d3.scaleThreshold()
	.domain([50, 100, 200, 400, 600, 800])
	.range(d3.schemeOrRd[7]);

// add tooltip
const tooltip = d3.select("body").append("div")
	.attr("class", "tooltip")
	.style("opacity", 0);


  const translate = {
  "AFG": "AFG",
  "ALB": "ALB",
  "ALG": "DZA",
  "ASA": "ASM",
  "AND": "AND",
  "ANG": "AGO",
  "ANT": "ATG",
  "ARG": "ARG",
  "ARM": "ARM",
  "ARU": "ABW",
  "AUS": "AUS",
  "AUT": "AUT",
  "AZE": "AZE",
  "BAH": "BHS",
  "BRN": "BHR",
  "BAN": "BGD",
  "BAR": "BRB",
  "BLR": "BLR",
  "BEL": "BEL",
  "BIZ": "BLZ",
  "BEN": "BEN",
  "BER": "BMU",
  "BHU": "BTN",
  "BOL": "BOL",
  "BIH": "BIH",
  "BOT": "BWA",
  "BRA": "BRA",
  "IVB": "VGB",
  "BRU": "BRN",
  "BUL": "BGR",
  "BUR": "BFA",
  "MYA": "MMR",
  "BDI": "BDI",
  "CAM": "KHM",
  "CMR": "CMR",
  "CAN": "CAN",
  "CPV": "CPV",
  "CAY": "CYM",
  "CAF": "CAF",
  "CHA": "TCD",
  "CHI": "CHL",
  "CHN": "CHN",
  "COL": "COL",
  "COM": "COM",
  "COK": "COK",
  "CRC": "CRI",
  "CRO": "HRV",
  "CUB": "CUB",
  "CYP": "CYP",
  "CZE": "CZE",
  "COD": "COD",
  "DEN": "DNK",
  "DJI": "DJI",
  "DMA": "DMA",
  "DOM": "DOM",
  "TLS": "TLS",
  "ECU": "ECU",
  "EGY": "EGY",
  "ESA": "SLV",
  "GEQ": "GNQ",
  "ERI": "ERI",
  "EST": "EST",
  "SWZ": "SWZ",
  "ETH": "ETH",
  "FSM": "FSM",
  "FIJ": "FJI",
  "FIN": "FIN",
  "FRA": "FRA",
  "GAB": "GAB",
  "GAM": "GMB",
  "GEO": "GEO",
  "GER": "DEU",
  "GHA": "GHA",
  "GRE": "GRC",
  "GRN": "GRD",
  "GUM": "GUM",
  "GUA": "GTM",
  "GUI": "GIN",
  "GBS": "GNB",
  "GUY": "GUY",
  "HAI": "HTI",
  "HON": "HND",
  "HKG": "HKG",
  "HUN": "HUN",
  "ISL": "ISL",
  "IND": "IND",
  "INA": "IDN",
  "IRI": "IRN",
  "IRQ": "IRQ",
  "IRL": "IRL",
  "ISR": "ISR",
  "ITA": "ITA",
  "CIV": "CIV",
  "JAM": "JAM",
  "JPN": "JPN",
  "JOR": "JOR",
  "KAZ": "KAZ",
  "KEN": "KEN",
  "KIR": "KIR",
  "KOS": "XKX",
  "KUW": "KWT",
  "KGZ": "KGZ",
  "LAO": "LAO",
  "LAT": "LVA",
  "LBN": "LBN",
  "LES": "LSO",
  "LBR": "LBR",
  "LBA": "LBY",
  "LIE": "LIE",
  "LTU": "LTU",
  "LUX": "LUX",
  "MAD": "MDG",
  "MAW": "MWI",
  "MAS": "MYS",
  "MDV": "MDV",
  "MLI": "MLI",
  "MLT": "MLT",
  "MHL": "MHL",
  "MTN": "MRT",
  "MRI": "MUS",
  "MEX": "MEX",
  "MDA": "MDA",
  "MGL": "MNG",
  "MNE": "MNE",
  "MAR": "MAR",
  "MOZ": "MOZ",
  "NAM": "NAM",
  "NRU": "NRU",
  "NEP": "NPL",
  "NED": "NLD",
  "NZL": "NZL",
  "NCA": "NIC",
  "NIG": "NER",
  "NGR": "NGA",
  "PRK": "PRK",
  "MKD": "MKD",
  "NOR": "NOR",
  "OMA": "OMN",
  "PAK": "PAK",
  "PLW": "PLW",
  "PLE": "PSE",
  "PAN": "PAN",
  "PNG": "PNG",
  "PAR": "PRY",
  "PER": "PER",
  "PHI": "PHL",
  "POL": "POL",
  "POR": "PRT",
  "MON": "MCO",
  "PUR": "PRI",
  "QAT": "QAT",
  "CGO": "COG",
  "ROU": "ROU",
  "RUS": "RUS",
  "RWA": "RWA",
  "SKN": "KNA",
  "LCA": "LCA",
  "VIN": "VCT",
  "SAM": "WSM",
  "SMR": "SMR",
  "STP": "STP",
  "KSA": "SAU",
  "SEN": "SEN",
  "SRB": "SRB",
  "SEY": "SYC",
  "SLE": "SLE",
  "SGP": "SGP",
  "SVK": "SVK",
  "SLO": "SVN",
  "SOL": "SLB",
  "SOM": "SOM",
  "RSA": "ZAF",
  "KOR": "KOR",
  "ESP": "ESP",
  "SRI": "LKA",
  "SUD": "SDN",
  "SUR": "SUR",
  "SWE": "SWE",
  "SUI": "CHE",
  "SYR": "SYR",
  "TPE": "TWN",
  "TJK": "TJK",
  "TAN": "TZA",
  "THA": "THA",
  "TOG": "TGO",
  "TGA": "TON",
  "TTO": "TTO",
  "TUN": "TUN",
  "TUR": "TUR",
  "TKM": "TKM",
  "TUV": "TUV",
  "UGA": "UGA",
  "UKR": "UKR",
  "UAE": "ARE",
  "GBR": "GBR",
  "USA": "USA",
  "URU": "URY",
  "UZB": "UZB",
  "VAN": "VUT",
  "VEN": "VEN",
  "VIE": "VNM",
  "ISV": "VIR",
  "YEM": "YEM",
  "ZAM": "ZMB",
  "ZIM": "ZWE"
}

// Load external data and boot
d3.queue()
	.defer(d3.json, worldmap)
	.defer(d3.csv, worldpopulation, function(d) {

    if(d.games == "1992 Summer"){

      data.set(translate[d.code], +d.participants);
      
    }
		
	})
	.await(ready);

// Add clickable background
svg.append("rect")
  .attr("class", "background")
	.attr("width", width)
	.attr("height", height)
	.on("click", click);


// ----------------------------
//Start of Choropleth drawing
// ----------------------------

function ready(error, topo) {
	// topo is the data received from the d3.queue function (the world.geojson)
	// the data from world_population.csv (country code and country population) is saved in data variable

	let mouseOver = function(d) {
		d3.selectAll(".Country")
			.transition()
			.duration(200)
			.style("opacity", .5)
			.style("stroke", "transparent");
		d3.select(this)
			.transition()
			.duration(200)
			.style("opacity", 1)
			.style("stroke", "black");
		tooltip.style("left", (d3.event.pageX + 15) + "px")
			.style("top", (d3.event.pageY - 28) + "px")
			.transition().duration(400)
			.style("opacity", 1)
			.text(d.properties.name + ': ' + d.total + ' athletes.'); //! mudar o texto do tooltip
	}

	let mouseLeave = function() {
		d3.selectAll(".Country")
			.transition()
			.duration(200)
			.style("opacity", 1)
			.style("stroke", "transparent");
		tooltip.transition().duration(300)
			.style("opacity", 0);
	}

	// Draw the map
	world = svg.append("g")
    .attr("class", "world");
	world.selectAll("path")
		.data(topo.features)
		.enter()
		.append("path")
		// draw each country
		// d3.geoPath() is a built-in function of d3 v4 and takes care of showing the map from a properly formatted geojson file, if necessary filtering it through a predefined geographic projection
		.attr("d", d3.geoPath().projection(projection))

		//retrieve the name of the country from data
		.attr("data-name", function(d) {
			return d.properties.name
		})

		// set the color of each country
		.attr("fill", function(d) {

			d.total = data.get(d.id) || 0;
			return colorScale(d.total);
		})

		// add a class, styling and mouseover/mouseleave and click functions
		.style("stroke", "transparent")
		.attr("class", function(d) {
			return "Country"
		})
		.attr("id", function(d) {
			return d.id
		})
		.style("opacity", 1)
		.on("mouseover", mouseOver)
		.on("mouseleave", mouseLeave)
		.on("click", click);
  
	// Legend
	const x = d3.scaleLinear()
		.domain([2.6, 75.1])
		.rangeRound([600, 860]);

	const legend = svg.append("g")
		.attr("id", "legend");

	const legend_entry = legend.selectAll("g.legend")
		.data(colorScale.range().map(function(d) {
			d = colorScale.invertExtent(d);
			if (d[0] == null) d[0] = x.domain()[0];
			if (d[1] == null) d[1] = x.domain()[1];
			return d;
		}))
		.enter().append("g")
		.attr("class", "legend_entry");

	const ls_w = 20,
		ls_h = 20;

	legend_entry.append("rect")
		.attr("x", 20)
		.attr("y", function(d, i) {
			return height - (i * ls_h) - 2 * ls_h;
		})
		.attr("width", ls_w)
		.attr("height", ls_h)
		.style("fill", function(d) {
			return colorScale(d[0]);
		})
		.style("opacity", 0.8);

	legend_entry.append("text")
		.attr("x", 50)
		.attr("y", function(d, i) {
			return height - (i * ls_h) - ls_h - 6;
		})
		.text(function(d, i) {
			if (i === 0) return "< " + d[1] / 1000000 + " m";
			if (d[1] < d[0]) return d[0] / 1000000 + " m +";
			return d[0] / 1000000 + " m - " + d[1] / 1000000 + " m";
		});

	legend.append("text").attr("x", 15).attr("y", 280).text("Population (Million)");
}

// Zoom functionality
function click(d) {
  var x, y, k;

  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = -(centroid[0] * 6);
    y = (centroid[1] * 6);
    k = 3;
    centered = d;
  } else {
    x = 0;
    y = 0;
    k = 1;
    centered = null;
  }

  world.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

  world.transition()
      .duration(750)
      .attr("transform", "translate(" + x + "," + y + ") scale(" + k + ")" );
  
}
</script>